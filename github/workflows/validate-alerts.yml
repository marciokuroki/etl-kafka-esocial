name: Validate Alerting System

on:
  push:
    branches: [ sprint3 ]
    paths:
      - 'config/prometheus/**'
      - 'config/alertmanager/**'
      - 'config/grafana/**'
  pull_request:
    branches: [ sprint3 ]
    paths:
      - 'config/prometheus/**'
      - 'config/alertmanager/**'
  workflow_dispatch:

jobs:
  validate-alerting:
    name: Validate Alerting Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Start Infrastructure
        run: |
          docker-compose up -d prometheus alertmanager
          sleep 30
      
      - name: ğŸ” Validate Prometheus Config
        run: |
          docker exec esocial-prometheus promtool check config /etc/prometheus/prometheus.yml
      
      - name: ğŸ” Validate Alert Rules
        run: |
          docker exec esocial-prometheus promtool check rules /etc/prometheus/alerts.yml
      
      - name: ğŸ” Validate Alertmanager Config
        run: |
          docker exec esocial-alertmanager amtool check-config /etc/alertmanager/config.yml
      
      - name: ğŸ§ª Run Validation Script
        run: |
          chmod +x scripts/validate-alerting-system.sh
          ./scripts/validate-alerting-system.sh --quick
      
      - name: ğŸ“Š Upload Validation Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-logs
          path: validation-*.log
          retention-days: 7
      
      - name: ğŸ›‘ Cleanup
        if: always()
        run: docker-compose down -v
