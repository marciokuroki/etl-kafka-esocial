# Configura√ß√£o do Alertmanager para Sistema eSocial ETL

global:
  resolve_timeout: 5m
  
  # Configura√ß√£o SMTP (descomente e configure se usar email)
  # smtp_smarthost: 'smtp.gmail.com:587'
  # smtp_from: 'alertas-esocial@empresa.com'
  # smtp_auth_username: 'seu-email@gmail.com'
  # smtp_auth_password: 'sua-senha-app'
  # smtp_require_tls: true

# Templates customizados
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Roteamento de alertas
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s        # Aguarda antes de enviar primeiro alerta
  group_interval: 10s    # Intervalo entre alertas do mesmo grupo
  repeat_interval: 12h   # Repete alerta se n√£o resolvido
  
  routes:
    # Alertas cr√≠ticos - notifica√ß√£o imediata
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 4h
      continue: true
    
    # Alertas de warning - agrupados
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 12h

# Receptores de notifica√ß√£o
receivers:
  # Receptor padr√£o - webhook para testes
  - name: 'default'
    webhook_configs:
      - url: 'http://webhook-receiver:5001/alerts'
        send_resolved: true
        max_alerts: 0

  # Receptor para alertas cr√≠ticos
  - name: 'critical-alerts'
    webhook_configs:
      - url: 'http://webhook-receiver:5001/alerts/critical'
        send_resolved: true
    
    # Email (descomente se configurado SMTP)
    # email_configs:
    #   - to: 'admin@s.com.br,suporte@s.com.br'
    #     subject: 'üö® [CR√çTICO] {{ .GroupLabels.alertname }} - Pipeline eSocial'
    #     html: |
    #       <h2 style="color: #d32f2f;">üö® Alerta Cr√≠tico - Pipeline eSocial</h2>
    #       <p><strong>Alerta:</strong> {{ .GroupLabels.alertname }}</p>
    #       <p><strong>Servi√ßo:</strong> {{ .GroupLabels.service }}</p>
    #       <p><strong>Severidade:</strong> {{ .GroupLabels.severity }}</p>
    #       <p><strong>Descri√ß√£o:</strong> {{ .CommonAnnotations.description }}</p>
    #       <p><strong>Hor√°rio:</strong> {{ .StartsAt.Format "02/01/2006 15:04:05" }}</p>
    #       {{ if .CommonAnnotations.action }}
    #       <h3>A√ß√µes Recomendadas:</h3>
    #       <pre>{{ .CommonAnnotations.action }}</pre>
    #       {{ end }}
    #       <p><a href="{{ .ExternalURL }}">Ver no Alertmanager</a></p>
    
    # Slack (descomente e configure o webhook URL)
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'
    #     channel: '#alerts-esocial-critical'
    #     title: 'üö® [CR√çTICO] {{ .GroupLabels.alertname }}'
    #     text: |
    #       *Servi√ßo:* {{ .GroupLabels.service }}
    #       *Descri√ß√£o:* {{ .CommonAnnotations.description }}
    #       *Hor√°rio:* {{ .StartsAt.Format "02/01/2006 15:04:05" }}
    #     send_resolved: true

  # Receptor para alertas de warning
  - name: 'warning-alerts'
    webhook_configs:
      - url: 'http://webhook-receiver:5001/alerts/warning'
        send_resolved: true
    
    # Email (descomente se configurado SMTP)
    # email_configs:
    #   - to: 'equipe@empresa.com'
    #     subject: '‚ö†Ô∏è [WARNING] {{ .GroupLabels.alertname }} - Pipeline eSocial'

# Inibi√ß√£o de alertas (evitar spam)
inhibit_rules:
  # Se um alerta cr√≠tico est√° ativo, n√£o envia warnings relacionados
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']
  
  # Se servi√ßo est√° down, n√£o alerta sobre outras m√©tricas dele
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '(HighErrorRate|HighLatency|HighConsumerLag)'
    equal: ['service']